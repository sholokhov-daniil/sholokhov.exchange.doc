# Базовое свойство

Класс: **Sholokhov\Exchange\Fields\Field**

Класс описания имеет стандартный набор методов, позволяющий настроить взаимодействие между источником данных и сущностью в которую производится запись.
Все стандартные классы описывающие свойство являются наследниками данного объекта.

| Наименование   | Обязательное | Тип данных                                                            | Описание                                                                                                                                                                                                                                                                                                                                                                 |
|----------------|--------------|-----------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| setPrimary     | **Да**       | boolean                                                               | Выступает в качестве идентификационного поля(связывает элементы сущности и элементы источника данных)                                                                                                                                                                                                                                                                    |
| setFrom        | **Да**       | string                                                                | Путь до значения, которое вернул источник. Если путь является вложенным, то каждый уровень разделяется символом "."                                                                                                                                                                                                                                                      |
| setTo          | **Да**       | string                                                                | В какой ключ будет записываться значение из структуры данных источника                                                                                                                                                                                                                                                                                                   |
| setHash        | Нет          | boolean                                                               | Свойство хранит идентификатор обмена                                                                                                                                                                                                                                                                                                                                     |
| setPreparation | Нет          | [callable](https://www.php.net/manual/ru/language.types.callable.php) | Пользовательский преобразователь значения текущего свойства                                                                                                                                                                                                                                                                                                              |
| setChildren    | Нет          | Sholokhov\Exchange\Fields\FieldInterface                              | Указывает путь до вложенного значения. Предназначен, для получения значения внутри итерируемых элементов                                                                                                                                                                                                                                                                 |
| setNormalizer  | Нет          | [callable](https://www.php.net/manual/ru/language.types.callable.php) | Указываем произвольный нормализатор значения - используется перед преобразованием значения на основе настроек сущности.Данный метод может подойти, если нам из источника приходят "грязные" данные.Пример: из источника приходит строка "Иванов\|34 года", а нам для импорта нужен только "Иванов".Наш нормализатор произведет форматирование значения к нужному формату |

> ⚠️ Внимание
> 
> В карте должно быть только одно свойство, которое выступает идентификационным **(setPrimary)**


## Нормализация значения

Рассмотрим пример использования пользовательского обработчика значений, в поле "user" хранятся значения формата **{фамилия}|{возраст}**
В рамках данной задачи нам необходимо из этой строки получить фамилию.

Наш нормализатор получает 2 входных параметра:
- Значение, которое необходимо нормализовать (может иметь любой тип данных)
- Свойство, значение которого нормализуем. Оно имеет тип данных **Sholokhov\Exchange\Fields\FieldInterface**

```php
use Sholokhov\Exchange\Fields\Field;
use Sholokhov\Exchange\Fields\FieldInterface;

$data = [
    [
        'user' => 'Иванов|34 года',
    ],
    [
        'user' => 'Пупкин|18'
    ]
];

$nameField = new Field;
$nameField->setFrom('user');
$nameField->setTo('USER')
$nameField->setNormalizer(fn(mixed $value, FieldInterface $field) => stristr($value, '|', true));
```

## Преобразователь значения

Каждое свойство наделено возможностью указания собственного преобразователя данных, если значение необходимо обработать уникальным подходом и игнорировать альтернативные решения.
Указав свойству собственный нормализатор, в таком случае все зарегистрированные нормализаторы внутри обмена игнорируются.

Результатом работы нормализатора служит объект реализующий интерфейс **Sholokhov\Exchange\Messages\DataResultInterface**

### Пример

Перед нами стоит цель: создать собственный преобразователь значения типа файл.
В качестве значения нам передается символьный код, который позволяет получить изображение из внешнего ресурса.

Может показаться, что можно использовать нормализатор данных, но нормализатор предназначен, для форматирования значения.
В нашем примере помимо преобразования пути предстоит произвести http запрос и скачать изображение, предварительно сохранив в файловой системе сервера.
Согласитесь, довольно много обязанностей, для обычного форматирования.

```php
use Sholokhov\Exchange\Fields\Field;
use Sholokhov\Exchange\Messages\Type\DataResult;

use Bitrix\Main\Error;
use Bitrix\Main\Web\HttpClient;


$field->setPreparation(function(mixed $value, FieldInterface $field) {
    $result = new DataResult;
    $url = 'https://myweb.com/upload/' . $value;
    
    $options = [
        'headers' => [
            'Authorization: OAuth MYToken'
        ]
    ];
    
    $http = new HttpClient($options);
    $tmp = CFile::GetTempName('', 'tmp.' . md5(mt_rand())); 
    
    if ($http->download($url, $tmp)) {
        $result->setData(
            CFile::MakeFileArray($tmp)
        );
    } else {
        $result->addError(new Error('Ошибка получения изображения: ' . $url));
    }
    
    return $result;
});
```

## Вложенный путь

В некоторых случаях нам может потребоваться получить значения внутри итерируемого объекта.
Рассмотрим пример на массиве, где нужно получить путь до изображения

```php
$source = [
    [
        'name' => 'Название элемента',
        'images' => [
            'image' => [
                [
                    'sdn' => 'https://web.ru/upload/1.png',
                    'name' => '1.png',
                ],
                [   
                    'sdn' => 'https://web.ru/upload/2.png',
                    'name' => '2.png'
                ]
            ]
        ]
    ],
    // ...
];

// ✅ Работает 
$field = new Field;
$field->setFrom('images.image');
$field->setChildren(
    (new Field)->setFrom('sdn')
);

// ❌ Не работает
$field = new Field;
$field->setFrom('images.image.sdn');
```

Разберем более подробно пример приведенный ранее.

Для этого нам необходимо понять как происходит парсинг значения.
У парсера зарезервирован символ ".", который отвечает за разделение уровней данных.
Если в пути используется символ ".", то это означает, что теперь производим поиск ключа внутри данного значения: **parentKey.childrenKey**.

Из этого следует, что нам необходимо явно указывать путь до нашего значения, соблюдая все ключи массива.
В примере мы дошли до массива изображений, и тут встала задача получения значения ключа "sdn" у каждого изображения.

Метод **setChildren** сообщает парсеру, что нужно зайти в каждый элемент массива и достать из него значение.
Вложенные пути могут быть более сложными - допускается возможность указать N вложенность

```php
$source = [
    [
        'name' => 'Название элемента',
        'images' => [
            'image' => [
                [
                    'sdn' => [
                        [
                            'path' => 'https://web.ru/upload/1.png'
                            'name' => '1.png',
                        ]
                    ]
                ],
                [   
                    'sdn' => [
                        [
                            'path' => 'https://web.ru/upload/2.png'
                            'name' => '2.png',
                        ]
                    ]
                ]
            ]
        ]
    ],
    // ...
];

$field = new Field;
$field->setFrom('images.image');
$field->setChildren(
    (new Field)
        ->setFrom('sdn')
        ->setChildren(
            (new Field)
                ->setFrom('path')
        )
);
```

Нам может потребоваться возможность получения только определенного значения внутри итерации.

Разберем пример, что перед нами стоит задача: получить путь только до первого изображения

```php
$source = [
    [
        'name' => 'Название элемента',
        'images' => [
            'image' => [
                [
                    'sdn' => 'https://web.ru/upload/1.png',
                    'name' => '1.png',
                ],
                [   
                    'sdn' => 'https://web.ru/upload/2.png',
                    'name' => '2.png'
                ]
            ]
        ]
    ],
    // ...
];

$field = new Field;
// т.к. в image хранится перечисляемый массив, то нам достаточно указать номер ключа
$field->setFrom('images.image.0.sdn');
```
